# 連続該当銘柄機能

この機能は、2営業日連続で押し目買い銘柄・ブレイク銘柄に該当している場合に、チャート図の銘柄名の先頭に「◎」をつける機能です。

## 機能概要

- **前回結果のバックアップ**: 実行時に現在の結果ファイルを前回結果として保存
- **連続該当判定**: 前回結果と今回結果を比較して連続該当銘柄を特定
- **銘柄名装飾**: 連続該当銘柄の銘柄名の先頭に「◎」を付与
- **チャート表示**: 装飾された銘柄名でチャートを生成

## 実装内容

### 1. 新規追加されたモジュール

#### `result_backup.py`
- **場所**: `StockSignal/result_backup.py`
- **機能**: 結果ファイルのバックアップと連続該当銘柄の判定機能を提供
- **含まれる関数**:
  - `backup_previous_results()`: 前回の結果ファイルをバックアップ
  - `get_consecutive_tickers()`: 連続該当銘柄を特定
  - `decorate_company_name()`: 連続該当銘柄の銘柄名に「◎」を付与

### 2. 修正された関数

#### `StockSignal/main.py`
- **新規追加**: `backup_previous_results()` の呼び出しを処理開始時に追加
- **目的**: 新しい結果生成前に前回結果をバックアップ

#### `Upload_WardPress.py`
- **修正**: バックアップ機能を `result_backup.py` からインポート
- **修正**: `main()` 関数から `backup_previous_results()` の呼び出しを削除
- **修正**: 連続該当銘柄の判定のみを実行（バックアップは `main.py` で完了済み）

#### `chart_generator.py`
- **修正**: バックアップ機能を `result_backup.py` からインポート
- **修正**: クラス内の重複関数を削除し、ユーティリティ関数を使用

### 2. 修正された関数

#### `Upload_WardPress.py`
- `generate_chart()`: 連続該当銘柄の情報を受け取り、銘柄名を装飾
- `generate_breakout_charts()`: 連続該当銘柄の情報を渡してチャート生成
- `generate_push_mark_charts()`: 連続該当銘柄の情報を渡してチャート生成
- `main()`: 処理順序を変更（バックアップ→連続判定→チャート生成）

#### `chart_generator.py`
- `generate_chart()`: 連続該当銘柄の情報を受け取り、銘柄名を装飾

### 3. 処理の流れ

1. **前回結果のバックアップ** (`StockSignal/main.py`)
   - 新しい結果生成前に前回の結果ファイルをバックアップ
   - `StockSignal/Result/Previous/` ディレクトリに現在の結果ファイルをコピー
   - `Breakout.csv` と `push_mark.csv` を対象

2. **新しい結果の生成** (`StockSignal/main.py`)
   - 株価データ取得、テクニカル指標計算、シグナル抽出を実行
   - 新しい `Breakout.csv` と `push_mark.csv` を生成

3. **連続該当銘柄の判定** (`Upload_WardPress.py`)
   - 前回結果（バックアップ済み）と今回結果を比較
   - ブレイク銘柄と押し目買い銘柄を別々に判定
   - 両方に含まれる銘柄を連続該当として特定

4. **銘柄名の装飾**
   - 連続該当銘柄の銘柄名の先頭に「◎」を付与
   - 例: `◎ 日本アクア (ROE：21.04%)`

5. **チャート生成とWordPress投稿**
   - 装飾された銘柄名でチャートを生成
   - WordPress投稿時に連続該当銘柄の一覧も表示

## ディレクトリ構成

```
StockSignal/Result/
├── Breakout.csv          # 今回のブレイク銘柄結果
├── push_mark.csv         # 今回の押し目買い銘柄結果
├── Previous/             # 前回結果のバックアップ
│   ├── Breakout.csv      # 前回のブレイク銘柄結果
│   └── push_mark.csv     # 前回の押し目買い銘柄結果
└── ... (その他のファイル)
```

## 使用方法

### 通常の実行
```bash
# 1. メイン処理（データ取得・分析・結果生成）
python main.py

# 2. WordPress投稿とチャート生成（連続該当銘柄の判定含む）
python Upload_WardPress.py
```

### 機能テスト
```bash
python test_consecutive_feature.py
```

### 重要な変更点
- **バックアップタイミング**: `backup_previous_results()` は `main.py` の開始時に実行
- **連続判定タイミング**: `get_consecutive_tickers()` は `Upload_WardPress.py` で実行
- **実行順序**: `main.py` → `Upload_WardPress.py` の順序で実行する必要があります

## 出力例

### 連続該当銘柄の一覧
WordPress投稿に以下のセクションが追加されます：

```
<h2>連続該当銘柄</h2>
<p>前回の結果と今回の結果で連続している銘柄です。</p>
<div class="scroll-box">
<p>◎ 日本アクア (ROE：21.04%)</p>
<p>◎ ジンジブ</p>
<p>◎ 高砂熱学工業 (ROE：20.16%)</p>
...
</div>
```

### チャートの銘柄名
連続該当銘柄のチャートには、銘柄名の先頭に「◎」が表示されます：
- `◎ 日本アクア (ROE：21.04%)`
- `◎ ジンジブ`
- `◎ 高砂熱学工業 (ROE：20.16%)`

## 注意事項

- **初回実行時**: 前回結果ファイルが存在しないため、連続該当判定は行われません
- **エラーハンドリング**: ファイル読み込みエラーの場合は通常表示で処理を継続
- **カテゴリ別判定**: ブレイク銘柄と押し目買い銘柄は別々に判定されます
- **営業日の考慮**: 実際の営業日ではなく、実行間隔で連続性を判定します

## 技術仕様

- **バックアップ方式**: ファイルコピー（`shutil.copy2`）
- **連続判定**: 集合演算（`&`）を使用
- **銘柄名装飾**: 文字列連結で「◎」を付与
- **エラー処理**: try-except文で各処理を保護
- **モジュール化**: バックアップ機能を `result_backup.py` に集約
- **実行順序**: `main.py` でバックアップ → 結果生成 → `Upload_WardPress.py` で連続判定

## 今後の拡張可能性

- **営業日判定**: 実際の営業日を考慮した連続性判定
- **履歴管理**: より長期間の履歴データの保存と分析
- **統計情報**: 連続該当銘柄のパフォーマンス分析
- **設定可能**: 連続判定の日数を設定可能にする
