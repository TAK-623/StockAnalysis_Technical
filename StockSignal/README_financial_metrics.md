# ROE情報追加機能（チャートROE値表示付き）

この機能は、ブレイク銘柄のCSVファイルにROE情報を追加し、ROE10%以上の銘柄のチャート図にROE値を表示するためのものです。

## 概要

yfinance APIを使用して、ブレイク銘柄のROE情報を自動取得し、以下の機能を提供します：

- **ROE(%)**: 株主資本利益率（パーセンテージ）
- **チャート図の銘柄名**: すべての銘柄にROE値を自動追加

## ファイル構成

- `add_roe_to_breakout.py` - ROE情報を追加するメインスクリプト
- `run_add_roe.bat` - 実行用バッチファイル
- `chart_generator.py` - チャート生成モジュール（すべての銘柄にROE値自動追加）
- `Upload_WardPress.py` - WordPress投稿モジュール（チャート生成時にすべての銘柄にROE値自動追加）

## 使用方法

### 1. 依存関係のインストール

```bash
pip install yfinance
```

### 2. ROE情報の追加

#### 方法1: バッチファイルを使用
```bash
run_add_roe.bat
```

#### 方法2: Pythonスクリプトを直接実行
```bash
python add_roe_to_breakout.py
```

### 3. チャート生成（すべての銘柄にROE値自動追加）

```bash
python chart_generator.py
```

### 4. WordPress投稿（チャート生成時にすべての銘柄にROE値自動追加）

```bash
python Upload_WardPress.py
```

## 出力ファイル

### Breakout.csv

処理が完了すると、`StockSignal/Result/Breakout.csv`が更新され、以下の列が含まれます：

```
Ticker,Company,テーマ,終値,ROE(%),BB上限(+2σ),前日までの最高値,上髭の長さ(%)
```

### チャート図の銘柄名

すべての銘柄のチャート図には、銘柄名にROE値が自動的に追加されます。ROE値は丸括弧で囲まれ、銘柄名との境界が明確になります。

例：
- `160A - S: アズパートナーズ (ROE：29.24%)`
- `7082 - G: ジモティー (ROE：38.04%)`
- `1663 - P: K＆OエナジーG (ROE：8.68%)`

### チャートファイル

チャート生成時には、`StockSignal/Result/{Ticker}_chart.png`として各銘柄のチャートが保存されます。

## 取得成功率

最新の実行結果（110銘柄中）：
- **ROE(%)**: 94/110銘柄 (85.5%)
- **ROE値表示**: 94/110銘柄 (85.5%) - チャート図にROE値付き

### ROE取得方法の改善

**2024年8月17日更新**: ROE取得方法を大幅に改善しました。

**従来の方法**: 財務情報から手動計算（Net Income / Total Stockholder Equity）
- 成功率: 約20-30%
- 問題: 日本株では「Total Stockholder Equity」が取得できない場合が多い

**新しい方法**: `stock.info.get('returnOnEquity')`を使用
- 成功率: **85.5%** (94/110銘柄)
- 利点: より確実で高速な取得が可能
- データ形式: 小数形式（例：0.11652）をパーセンテージ（11.65%）に自動変換

## 注意事項

1. **API制限**: yfinance APIには制限があるため、銘柄間で0.5秒の待機時間を設けています
2. **データ品質**: 一部の銘柄ではROEデータが取得できない場合があります
3. **処理時間**: 110銘柄の処理に約3-4分かかります
4. **エラーハンドリング**: 取得できない銘柄は空欄（NaN）として記録されます
5. **ROE値表示**: すべての銘柄のチャート図には自動的にROE値が追加されます（丸括弧で囲まれて表示）
6. **ファイル構成**: 不要なテストファイルは削除され、運用に必要なファイルのみが残されています

## トラブルシューティング

### ROEデータが取得できない場合

1. インターネット接続を確認
2. yfinanceライブラリが正しくインストールされているか確認
3. 銘柄コードが正しいか確認

### 処理が途中で停止する場合

1. ネットワーク接続を確認
2. 再度実行を試行
3. 必要に応じて待機時間を調整（`time.sleep(0.5)`の値を変更）

### チャートが生成されない場合

1. 必要なパッケージがインストールされているか確認
2. TechnicalSignalフォルダに株価データファイルが存在するか確認
3. company_list_20250426.csvファイルが存在するか確認

## 統合機能

### ブレイク銘柄検出との統合

ROE情報取得機能は、`breakout.py`に統合されています。ブレイク銘柄検出時に自動的にROE情報も取得されます。

### チャート生成との統合

ROE情報取得機能は、チャート生成機能（`chart_generator.py`、`Upload_WardPress.py`）と統合されています。チャート生成時に自動的にROE情報を取得し、すべての銘柄にROE値を追加します。

統合機能を使用する場合は、チャート生成時に以下の処理が自動的に実行されます：

```python
# ROE情報を取得してROE値を追加
roe = get_roe_for_ticker(ticker)
if roe is not None:
    company_name += f' (ROE：{roe:.2f}%)'
```

### 運用フロー

1. **ブレイク銘柄検出**: `breakout.py`でブレイク銘柄を検出し、ROE情報も同時に取得
2. **チャート生成**: `chart_generator.py`または`Upload_WardPress.py`でチャート生成時にすべての銘柄にROE値を自動追加
3. **ROE情報の追加**: 必要に応じて`add_roe_to_breakout.py`でROE情報のみを追加

## ライセンス

この機能は既存のプロジェクトの一部として提供されています。
